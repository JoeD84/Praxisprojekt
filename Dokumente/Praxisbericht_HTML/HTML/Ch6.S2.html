<!DOCTYPE html><html>
  <head>
    <title>6.2 Interrupts ‣ Chapter 6 Probleme und Lösungen</title>
    <!--Generated by LaTeXML (version 0.7.9alpha) on 2012-06-25T23:30:53+02:00.
        See http://dlmf.nist.gov/LaTeXML/-->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="start" href="Praxisbericht.html" title="">
    <link rel="prev" href="Ch6.S1.html" title="6.1 Entwicklungsumgebungen ‣ Chapter 6 Probleme und Lösungen">
    <link rel="next" href="Ch6.S3.html" title="6.3 Fuses ‣ Chapter 6 Probleme und Lösungen">
    <link rel="stylesheet" type="text/css" href="core.css">
    <link rel="stylesheet" type="text/css" href="navbar-left.css">
  </head>
  <body>
    <nav class="navbar"><a href="Praxisbericht.html" title="" class="ref start">?</a>
    
  <ul class="toc">
  <li class="tocentry">
<a href="Praxisbericht.html" title="" class="ref toc">?</a>
  <ul class="toc">
  <li class="tocentry"><a href="Ch1.html" title="Chapter 1 Hinweise zum Dokument" class="ref toc"><span class="text reftitle"><span class="tag">1 </span>Hinweise zum Dokument</span></a></li>
  <li class="tocentry"><a href="Ch2.html" title="Chapter 2 Einleitung" class="ref toc"><span class="text reftitle"><span class="tag">2 </span>Einleitung</span></a></li>
  <li class="tocentry"><a href="Ch3.html" title="Chapter 3 Vorstellung der vorhandenen Hardware" class="ref toc"><span class="text reftitle"><span class="tag">3 </span>Vorstellung der vorhandenen Hardware</span></a></li>
  <li class="tocentry"><a href="Ch4.html" title="Chapter 4 Vorstellung der vorhandenen Software" class="ref toc"><span class="text reftitle"><span class="tag">4 </span>Vorstellung der vorhandenen Software</span></a></li>
  <li class="tocentry"><a href="Ch5.html" title="Chapter 5 Zeitlicher Arbeitsablauf" class="ref toc"><span class="text reftitle"><span class="tag">5 </span>Zeitlicher Arbeitsablauf</span></a></li>
  <li class="tocentry">
<a href="Ch6.html" title="Chapter 6 Probleme und Lösungen" class="ref toc"><span class="text reftitle"><span class="tag">6 </span>Probleme und Lösungen</span></a>
  <ul class="toc">
  <li class="tocentry"><a href="Ch6.S1.html" title="6.1 Entwicklungsumgebungen ‣ Chapter 6 Probleme und Lösungen" class="ref toc"><span class="text reftitle"><span class="tag">6.1 </span>Entwicklungsumgebungen</span></a></li>
  <li class="tocentry self">
<span class="ref toc here"><span class="text reftitle"><span class="tag">6.2 </span>Interrupts</span></span>
  <ul class="toc">
  <li class="tocentry"><a href="#SS1" title="6.2.1 Endschalter ‣ 6.2 Interrupts ‣ Chapter 6 Probleme und Lösungen" class="ref toc"><span class="text reftitle"><span class="tag">6.2.1 </span>Endschalter</span></a></li>
  <li class="tocentry"><a href="#SS2" title="6.2.2 Watchdog ‣ 6.2 Interrupts ‣ Chapter 6 Probleme und Lösungen" class="ref toc"><span class="text reftitle"><span class="tag">6.2.2 </span>Watchdog</span></a></li>
    </ul>
</li>
  <li class="tocentry"><a href="Ch6.S3.html" title="6.3 Fuses ‣ Chapter 6 Probleme und Lösungen" class="ref toc"><span class="text reftitle"><span class="tag">6.3 </span>Fuses</span></a></li>
    </ul>
</li>
  <li class="tocentry"><a href="Ch7.html" title="Chapter 7 Fazit und weitere Möglichkeiten" class="ref toc"><span class="text reftitle"><span class="tag">7 </span>Fazit und weitere Möglichkeiten</span></a></li>
  <li class="tocentry"><a href="bib.html" title="Bibliography" class="ref toc"><span class="text reftitle">Bibliography</span></a></li>
  <li class="tocentry"><a href="idx.html" title="Index" class="ref toc"><span class="text reftitle">Index</span></a></li>
    </ul>
</li>
    </ul>
      </nav>
    <div class="main">
    <header class="header"><a href="Ch6.html" title="Chapter 6 Probleme und Lösungen" class="ref up"><span class="text reftitle"><span class="tag">6 </span>Probleme und Lösungen</span></a><a href="Ch6.S1.html" title="6.1 Entwicklungsumgebungen ‣ Chapter 6 Probleme und Lösungen" class="ref previous"><span class="text reftitle"><span class="tag">6.1 </span>Entwicklungsumgebungen</span></a><a href="Ch6.S3.html" title="6.3 Fuses ‣ Chapter 6 Probleme und Lösungen" class="ref next"><span class="text reftitle"><span class="tag">6.3 </span>Fuses</span></a>
      </header>
    <div class="content">
<section class="section"><hgroup><h1 class="title">
<span class="tag">6.2 </span>Interrupts</h1></hgroup><div id="p1" class="para"><p class="p">Viele Mikrocontroller bieten die Möglichkeit <em class="emph">eventbasierte</em> <span class="text" style="background-color:#D9D9FF;">Subroutinen</span> auszuführen. Wenn ein sogenannter <span class="text" style="background-color:#D9D9FF;">Interrupt</span> ausgelöst wird, wird das Hauptprogramm unterbrochen und eine entsprechende <span class="text" style="background-color:#D9D9FF;">Interrupt-Service-Routine</span>, kurz ISR, ausgeführt. Nach Beendigung der ISR wird das Hauptprogramm an der Stelle wieder aufgenommen, an der es unterbrochen wurde. ISR dürfen nur sehr wenige Befehle enthalten und sollten innerhalb weniger <span class="text" style="background-color:#D9D9FF;">Taktzyklen</span> abgeschlossen sein.<br class="break">Interrupts können z.B. der Überlauf eines internen Timer, oder ein externens Signal an einem Pin sein. Im Projekt werden Externe-Interrupts für die Endschalter, Timer-Überlauf-Interrupts für das Entprellen der Taster und der Watchdog-Interrupt zum erkennen von Fehlern genutzt.</p></div>
<section id="SS1" class="subsection"><hgroup><h1 class="title">
<span class="tag">6.2.1 </span>Endschalter</h1></hgroup><div id="SS1.p1" class="para"><p class="p">Die Endschalter sind über die Schrittmotorkarten und eine Brücke auf der Rückseite der Einschubsteckplätze mit der Mikrocontrollerplatine verbunden. Dort sind sie an 2 Interrupt Pins angeschlossen. Bei einem Flankenwechsel an den Pins wird ein Interrupt ausgelöst. <br class="break">Mit den Zeilen 1–2 des Codelistings <a href="#LST19" title="19 ‣ 6.2.1 Endschalter ‣ 6.2 Interrupts ‣ Chapter 6 Probleme und Lösungen" class="ref"><span class="text reftag">19</span></a> werden Pin-Change-Interrupts für bestimmte Pins zugelassen. Die Zeilen 3–7 und 8–12 zeigen die Interrupt-Service-Routinen für die beiden Interrupts.</p></div>
<figure id="LST19" class="listing language_C"><figcaption class="caption"><span class="tag">Listing 19: </span>ISR: Endschalter</figcaption><table class="tabular">
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">1</span></td>
    <td class="td"><span class="text lstline footnote">PCMSK3<span class="text lstspace">   </span>|=<span class="text lstspace"> </span>(<span class="text lstspace"> </span>1<span class="text lstspace"> </span>&lt;&lt;<span class="text lstspace"> </span>PCINT28<span class="text lstspace"> </span>);<span class="text lstspace">  </span>//<span class="text lstspace" style="color:#008000;"> </span><span class="text" style="color:#008000;">Interrupts<span class="text lstspace"> </span>definierenPD4<span class="text lstspace"> </span>als<span class="text lstspace"> </span>Interrupt<span class="text lstspace"> </span>zulassen</span></span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">2</span></td>
    <td class="td"><span class="text lstline footnote">PCICR<span class="text lstspace">    </span>|=<span class="text lstspace"> </span>(<span class="text lstspace"> </span>1<span class="text lstspace"> </span>&lt;&lt;<span class="text lstspace"> </span>PCIE3<span class="text lstspace">   </span>);<span class="text lstspace">   </span>//<span class="text lstspace" style="color:#008000;"> </span><span class="text" style="color:#008000;">Pin<span class="text lstspace"> </span>Change<span class="text lstspace"> </span>Interrupt<span class="text lstspace"> </span>ControlR<span class="text lstspace"> </span>PCIE3<span class="text lstspace"> </span>setzen<span class="text lstspace"> </span>fuer<span class="text lstspace"> </span>PCINT30</span></span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">3</span></td>
    <td class="td"><span class="text lstline footnote">ISR(PCINT3_vect){<span class="text lstspace">   </span>//<span class="text lstspace" style="color:#008000;"> </span><span class="text" style="color:#008000;">+<span class="text lstspace"> </span>Endschalter<span class="text lstspace"> </span>Position<span class="text lstspace"> </span>erreicht</span></span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">4</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">  </span>lcd_clrscr();</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">5</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">  </span>lcd_puts(”<span class="text" style="color:#000000;">Obere\nEndposition\nErreicht!</span>”);</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">6</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">  </span>LED_PORT<span class="text lstspace"> </span>^=<span class="text lstspace"> </span>(1<span class="text lstspace"> </span>&lt;&lt;<span class="text lstspace"> </span>LED3);</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">7</span></td>
    <td class="td"><span class="text lstline footnote">}</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">8</span></td>
    <td class="td"><span class="text lstline footnote">ISR(PCINT2_vect){<span class="text lstspace">   </span>//<span class="text lstspace" style="color:#008000;"> </span><span class="text" style="color:#008000;">-<span class="text lstspace"> </span>Endschalter<span class="text lstspace"> </span>Position<span class="text lstspace"> </span>erreicht</span></span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">9</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">  </span>lcd_clrscr();</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">10</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">  </span>lcd_puts(”<span class="text" style="color:#000000;">Untere\nEndposition\nErreicht!</span>”);</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">11</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">  </span>LED_PORT<span class="text lstspace"> </span>^=<span class="text lstspace"> </span>(1<span class="text lstspace"> </span>&lt;&lt;<span class="text lstspace"> </span>LED3);</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">12</span></td>
    <td class="td"><span class="text lstline footnote">}</span></td>
</tr>
</table></figure></section><section id="SS2" class="subsection"><hgroup><h1 class="title">
<span class="tag">6.2.2 </span>Watchdog</h1></hgroup><div id="SS2.p1" class="para"><p class="p">Der <span class="text" style="background-color:#D9D9FF;">Watchdog</span> ist eine Sicherungseinrichtung des Mikrocontroller. In regelmäßigen Abständen wird überprüft ob das Watchdog-Bit gesetzt ist und anschließend zurück gesetzt. Das Bit muss innerhalb der voreingestellten Zeit immer wieder neu gesetzt werden. Dies kann mit der Funktion <span class="text typewriter" style="color:#0000FF;background-color:#FFFFE6;">wdt_reset()</span> realisiert werden. Ist das Bit nicht gesetzt, wird der Mikrocontroller zurückgesetzt. Dies geschieht z.B. bei ungewollten Endlosschleifen.<br class="break">Mit den Zeilen 3–10 des Codelisting <a href="#LST20" title="20 ‣ 6.2.2 Watchdog ‣ 6.2 Interrupts ‣ Chapter 6 Probleme und Lösungen" class="ref"><span class="text reftag">20</span></a> wird der Watchdog initialisiert und festgelegt in welchen Zeitintervallen das Watchdog-Bit überprüft werden soll. Der Ablauf zum einstellen des Zeitinveralls muss genau wie im Datenblatt des Mikrocontroller beschrieben eingehalten werden. Dies verhindert ein versehentliches Ändern der Einstellung.
Ist das Fusebit <em class="emph">WDTON</em> gesetzt kann der Watchdog nicht abgeschaltet werden (siehe Kapitel <a href="Ch6.S3.html" title="6.3 Fuses ‣ Chapter 6 Probleme und Lösungen" class="ref"><span class="text reftag">6.3</span></a>).<br class="break">Wahlweise kann kurz vor dem zurücksetzen des Mikrocontroller noch die Watchdog-ISR durchlaufen werden. Im Projekt wird in der ISR die <em class="emph">Fehler-LED</em> eingeschaltet und eine Meldung auf dem LC-Display ausgegeben (siehe Codelisting <a href="#LST20" title="20 ‣ 6.2.2 Watchdog ‣ 6.2 Interrupts ‣ Chapter 6 Probleme und Lösungen" class="ref"><span class="text reftag">20</span></a> Zeilen 12-16).</p></div>
<figure id="LST20" class="listing language_C"><figcaption class="caption"><span class="tag">Listing 20: </span>Watchdog</figcaption><table class="tabular">
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">1</span></td>
    <td class="td"><span class="text lstline footnote">include<span class="text lstspace"> </span>&lt;avr/wdt.h&gt;</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">2</span></td>
    <td class="td"><span class="text lstline footnote">//<span class="text lstspace"> </span>Initialisierung<span class="text lstspace"> </span>des<span class="text lstspace"> </span>Watchdog</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">3</span></td>
    <td class="td"><span class="text lstline footnote">void<span class="text lstspace"> </span>init_WDT(void)<span class="text lstspace"> </span>{</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">4</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">    </span>cli();</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">5</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">    </span>wdt_reset();</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">6</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">    </span>WDTCSR<span class="text lstspace"> </span>|=<span class="text lstspace"> </span>(1<span class="text lstspace"> </span>&lt;&lt;<span class="text lstspace"> </span>WDCE)<span class="text lstspace"> </span>|<span class="text lstspace"> </span>(1<span class="text lstspace"> </span>&lt;&lt;<span class="text lstspace"> </span>WDE);</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">7</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">    </span>WDTCSR<span class="text lstspace"> </span>=<span class="text lstspace"> </span>(1<span class="text lstspace"> </span>&lt;&lt;<span class="text lstspace"> </span>WDE)<span class="text lstspace"> </span>|<span class="text lstspace"> </span>(1<span class="text lstspace"> </span>&lt;&lt;<span class="text lstspace"> </span>WDIE)<span class="text lstspace"> </span>|<span class="text lstspace"> </span>(1<span class="text lstspace"> </span>&lt;&lt;<span class="text lstspace"> </span>WDP3)<span class="text lstspace"> </span>|<span class="text lstspace"> </span>(1<span class="text lstspace"> </span>&lt;&lt;<span class="text lstspace"> </span>WDP0);<span class="text lstspace"> </span>//Watchdog<span class="text lstspace"> </span>8s</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">8</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">    </span>//WDTCSR<span class="text lstspace"> </span>=<span class="text lstspace"> </span>0x0F;<span class="text lstspace"> </span>//Watchdog<span class="text lstspace"> </span>Off</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">9</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">    </span>sei();</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">10</span></td>
    <td class="td"><span class="text lstline footnote">}</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">11</span></td>
    <td class="td"><span class="text lstline footnote">//<span class="text lstspace"> </span>Watchdog<span class="text lstspace"> </span>ISR</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">12</span></td>
    <td class="td"><span class="text lstline footnote">ISR(WDT_vect){</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">13</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">        </span>LED_PORT<span class="text lstspace"> </span>&amp;=~(1<span class="text lstspace"> </span>&lt;&lt;<span class="text lstspace"> </span>LED4);//<span class="text lstspace"> </span>LED5<span class="text lstspace"> </span>einschalten</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">14</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">        </span>lcd_clrscr();</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">15</span></td>
    <td class="td"><span class="text lstline footnote"><span class="text lstspace">        </span>lcd_puts(”Something<span class="text lstspace"> </span>went<span class="text lstspace"> </span>\nterribly<span class="text lstspace"> </span>wrong!\nRebooting!”);</span></td>
</tr>
<tr class="tr">
    <td class="td linenumber"><span class="text tiny">16</span></td>
    <td class="td"><span class="text lstline footnote">}</span></td>
</tr>
</table></figure></section></section>
        </div>
    <footer class="footer">June 25, 2012<a href="Ch6.S1.html" title="6.1 Entwicklungsumgebungen ‣ Chapter 6 Probleme und Lösungen" class="ref previous"><span class="text reftitle"><span class="tag">6.1 </span>Entwicklungsumgebungen</span></a><a href="Ch6.S3.html" title="6.3 Fuses ‣ Chapter 6 Probleme und Lösungen" class="ref next"><span class="text reftitle"><span class="tag">6.3 </span>Fuses</span></a>
      </footer>
      </div>
    </body>
</html>
